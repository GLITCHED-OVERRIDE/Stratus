<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stratus Launcher</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body { background:#000; color:#fff; font-family:Arial; padding:70px 20px 20px 20px; }
.item { background:#111; padding:15px; margin:15px auto; width:85%; cursor:pointer; border:1px solid #fff; border-radius:10px; text-align:center; }
</style>
</head>
<body>

<h1>Stratus Launcher</h1>
<div id="apps"></div>

<script>
const JSON_URL = "https://raw.githubusercontent.com/GLITCHED-OVERRIDE/Stratus/refs/heads/main/Apps.json";

async function loadApps() {
    const res = await fetch(JSON_URL);
    const apps = await res.json();
    const container = document.getElementById("apps");

    apps.forEach(app=>{
        const div = document.createElement("div");
        div.className = "item";
        div.textContent = app.name;
        div.addEventListener("click",()=>launchApp(app));
        container.appendChild(div);
    });
}

loadApps();

async function launchApp(app) {
    // Fetch ZIP
    const res = await fetch(app.url);
    const blob = await res.blob();
    const zip = await JSZip.loadAsync(blob);

    // Open new window
    const win = window.open("about:blank");
    win.document.write('<!DOCTYPE html><html><head><title>'+app.name+'</title></head><body style="margin:0;background:#000;color:#fff;"><div id="header" style="position:fixed;top:0;width:100%;height:60px;background:#111;display:flex;align-items:center;justify-content:space-between;padding:0 15px;z-index:1000;"><span style="font-weight:bold;font-size:20px;">'+app.name+'</span><button id="installBtn" style="padding:8px 15px;">Install PWA</button></div><div id="content" style="margin-top:60px;"></div></body></html>');

    const fileMap = {};

    // Create blob URLs for all files
    for(const filename of Object.keys(zip.files)){
        const fileBlob = await zip.files[filename].async("blob");
        fileMap[filename] = URL.createObjectURL(fileBlob);
    }

    // Load index.html
    const indexFileName = Object.keys(fileMap).find(f=>f.endsWith("index.html"));
    if(!indexFileName){
        win.document.getElementById("content").innerHTML = "No index.html found in ZIP";
        return;
    }

    const iframe = win.document.createElement("iframe");
    iframe.style.width = "100%";
    iframe.style.height = "90vh";
    iframe.style.border = "none";

    iframe.src = fileMap[indexFileName];
    win.document.getElementById("content").appendChild(iframe);

    // Optionally setup PWA install prompt
    let deferredPrompt = null;
    win.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
    });

    const installBtn = win.document.getElementById("installBtn");
    installBtn.addEventListener("click", async ()=>{
        if(deferredPrompt){
            deferredPrompt.prompt();
            const choice = await deferredPrompt.userChoice;
            if(choice.outcome === 'accepted') console.log('App installed');
            deferredPrompt = null;
        } else {
            alert("Install prompt not available.");
        }
    });
}
</script>

</body>
</html>
